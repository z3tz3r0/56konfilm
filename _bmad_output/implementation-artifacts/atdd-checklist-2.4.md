# ATDD Checklist - Epic 2, Story 4: Admin Multi-Drag-and-Drop Efficiency

**Date:** 2026-02-02
**Author:** Z3tz3r0
**Primary Test Level:** Component (Sanity Config)

---

## Story Summary

Enable content admins to drag and drop multiple media files (images/videos) into the Media Gallery array in Sanity Studio, automatically creating correct `galleryItem` objects with uploaded assets. This replaces the tedious manual "Add Item" -> "Select Type" -> "Upload" process for each file.

**As a** Content Admin
**I want** to drag and drop multiple media files at once
**So that** I don't have to manually create 20 separate items one by one

---

## Acceptance Criteria

1. **Given** I am editing a `MediaGallerySection`
   **When** I drag multiple files (Images OR Videos) onto the "Items" array input
   **Then** the files should begin uploading in parallel automatically
   **And** valid `galleryItem` objects should be created for each file once uploaded

2. **Given** I upload a **JPEG/PNG** image
   **Then** the system creates a `galleryItem` with `mediaType` = "image" and `media.image` reference

3. **Given** I upload a **MP4/WebM** video
   **Then** the system creates a `galleryItem` with `mediaType` = "video" and `videoFile` reference

4. **Given** the upload is in progress
   **Then** I should see visual feedback (toast/indicator)

5. **Given** the upload finishes
   **Then** the new items should appear at the END of the list

---

## Failing Tests Created (RED Phase)

### Component Tests (3 tests)

**File:** `src/sanity/components/inputs/MultiUploadArrayInput.test.tsx`

- ✅ **Test:** AC1: Should handle file drop and upload images
  - **Status:** RED - Mock upload not called (Component empty)
  - **Verifies:** Drop event handling, file detection, and API asset upload trigger for Images.

- ✅ **Test:** AC3: Should handle video uploads specifically
  - **Status:** RED - Mock upload not called
  - **Verifies:** Generic File upload ('file' vs 'image') trigger for Video MIME types.

- ✅ **Test:** AC4: Should show toast on success
  - **Status:** RED - Toast spy not called
  - **Verifies:** Visual feedback via `@sanity/ui` toast.

---

## Required data-testid Attributes

N/A - This is a Sanity Studio component test using React Testing Library semantics (getByText), not an E2E test requiring DOM `data-testid` injection in the app.

---

## Implementation Checklist

### Test: MultiUploadArrayInput.test.tsx

**File:** `src/sanity/components/inputs/MultiUploadArrayInput.tsx`

**Tasks to make these tests pass:**

- [ ] Import `components/inputs/MultiUploadArrayInput.test.tsx` into VS Code to verify red state.
- [ ] Implement `MultiUploadArrayInput` component structure wrapping `renderDefault`.
- [ ] Add a `div` or `Card` acting as a DropZone (visible text "Multi Upload Input" or similar instructions).
- [ ] Add `onDrop` and `onDragOver` event handlers.
- [ ] Implement `handleFiles` function:
  - [ ] Loop `files` from event.
  - [ ] Determine type: `image/*` -> 'image', `video/*` -> 'file'.
- [ ] Call `client.assets.upload(type, file)` for each.
- [ ] On success, construct `galleryItem` patch keys:
  - [ ] `_type: 'galleryItem'`
  - [ ] `mediaType`: 'image' | 'video'
  - [ ] `_key`: uuid
- [ ] Dispatch patches via `onChange`.
- [ ] Add `useToast` to show success/error messages.
- [ ] Run test: `npx vitest run src/sanity/components/inputs/MultiUploadArrayInput.test.tsx`
- [ ] ✅ Test passes (green phase)

**Estimated Effort:** 2 hours

---

## Running Tests

```bash
# Run unit tests
npx vitest run src/sanity/components/inputs/MultiUploadArrayInput.test.tsx

# Watch mode
npx vitest src/sanity/components/inputs/MultiUploadArrayInput.test.tsx
```

---

## Red-Green-Refactor Workflow

### RED Phase (Complete) ✅

**TEA Agent Responsibilities:**

- ✅ Failing Component tests written
- ✅ Component Skeleton created
- ✅ Dependencies (`vite`, `testing-library`) verified available

**Verification:**

- `npx vitest` confirms 3 failed tests.
- Failures are due to missing implementation (timeouts expecting mock calls).

### GREEN Phase (DEV Team - Next Steps)

1. **Implement Drop logic** in `MultiUploadArrayInput.tsx`.
2. **Implement Upload logic** using `useClient`.
3. **Run tests** and verify passing.

### REFACTOR Phase

1. Improve UI feedback (progress bars?).
2. Extract upload logic to a hook `useSanityUpload` if complex.
3. Ensure types are robust.

---

## Notes for DEV Agent

- This mechanism runs inside Sanity Studio.
- Ensure you use `client` from `useClient()` hook.
- Ensure `onChange` patches append to the array correctly (`setIfMissing` + `insert`).
- **MIME Types:** Verify `input.files[i].type` for basic validation.

---

**Generated by BMad TEA Agent** - 2026-02-02
